# Оценка риска ДТП по выбранному маршруту движения

Вы — специалист по Data Sciense в каршеринговой компании. Вам поступил заказ: нужно создать систему, которая могла бы оценить риск ДТП по выбранному маршруту движения. 

Под риском понимается вероятность ДТП с любым повреждением транспортного средства. Как только водитель забронировал автомобиль, сел за руль и выбрал маршрут, система должна оценить уровень риска. Если уровень риска высок, водитель увидит предупреждение и рекомендации по маршруту.

Идея создания такой системы находится в стадии предварительного обсуждения и проработки. Чёткого алгоритма работы и подобных решений на рынке ещё не существует. Текущая задача — понять, возможно ли предсказывать ДТП, опираясь на исторические данные одного из регионов.

Заказчик предлагает вам поработать с базой данных по происшествиям и сформировать свои идеи создания такой системы. Идея решения задачи от заказчика: 

1. Создать модель предсказания ДТП (целевое значение — at_fault (виновник) в таблице parties)
    - Для модели выбрать тип виновника — только машина (car).
    - Выбрать случаи, когда ДТП привело к любым повреждениям транспортного средства, кроме типа SCRATCH (царапина).
    - Для моделирования ограничиться данными за 2012 год — они самые свежие.
    - Обязательное условие — учесть фактор возраста автомобиля.
    
    
2. На основе модели исследовать основные факторы ДТП.


3. Понять, помогут ли результаты моделирования и анализ важности факторов ответить на вопросы:
    - Возможно ли создать адекватную системы оценки водительского риска при выдаче авто?
    - Какие ещё факторы нужно учесть?
    - Нужно ли оборудовать автомобиль какими-либо датчиками или камерой?

 Оформление: Выполните задание в Jupyter Notebook. Заполните программный код в ячейках типа code, текстовые пояснения — в ячейках типа markdown. Примените форматирование и заголовки.   

 Краткое описание таблиц

**collisions — общая информация о ДТП**

Имеет уникальный case_id. Эта таблица описывает общую информацию о ДТП. Например, где оно произошло и когда.

**parties — информация об участниках ДТП**

Имеет неуникальный case_id, который сопоставляется с соответствующим ДТП в таблице collisions. Каждая строка здесь описывает одну из сторон, участвующих в ДТП. Если столкнулись две машины, в этой таблице должно быть две строки с совпадением case_id. Если нужен уникальный идентификатор, это case_id and party_number.

**vehicles — информация о пострадавших машинах**

Имеет неуникальные case_id и неуникальные party_number, которые сопоставляются с таблицей collisions и таблицей parties. Если нужен уникальный идентификатор, это case_id and party_number.

![Описание таблиц данных](https://github.com/vadimprimakov/Yandex_practicum_DS_Plus/blob/main/16_car_crash/16_car_crash.png)


## Цель исследования:

Cоздание системы, которая могла бы оценить риск ДТП по выбранному маршруту движения, используя sql-запросы и смоделировав не менее 3-х типов моделей с перебором гиперпараметров. Продемонстрировать заказчику, помогут ли результаты моделирования и анализ важности факторов в решении поставленной задачи.

## Ход исследования:

Шаг 1. Загрузим таблицы sql

Подключимся к базе данных, используя данные:

db_config = {
'user': 'praktikum_student', # имя пользователя,
'pwd': 'Sdf4$2;d-d30pp', # пароль,
'host': 'rc1b-wcoijxj3yxfsf3fs.mdb.yandexcloud.net',
'port': 6432, # порт подключения,
'db': 'data-science-vehicle-db' # название базы данных,
} 

Шаг 2. Проведем первичное исследование таблиц

- Все ли таблицы имеют набор данных;
- Соответствует ли количество таблиц условию задачи;
- Имеется ли общий ключ для связи таблиц.

Для осмотра таблиц используем sql-запрос.

Шаг 3. Проведем статистический анализ факторов ДТП

1. Выясним, в какие месяцы происходит наибольшее количество аварий, проанализировав весь период наблюдений (таблица collisions).
    - Создадим sql-запрос;
    - Построим график;
    - Сделаем вывод.
    
2. Скоро состоится первое совещание вашей рабочей группы. Чтобы обсуждение было конструктивным, каждый сотрудник должен понимать данные. Для этого создадим подходящие аналитические задачи и поручим их решение коллегам. 
    
2.1. Создадим не менее шести задач для коллег. Опирайтесь на примеры и таблицы. 

1. Оценить серьёзность повреждений ТС, исходя из состояния водителя;
2. Оцените сумму страховых выплат в зависимости от возраста автомобиля;
3. Оцените серьёзность повреждений ТС, исходя из типа участника ДТП;
4. Определите регионы, в которых чаще всего возникают ДТП, для этих регионов определите категории нарушений;
5. Определите серьёзность повреждений ТС в зависимости от года выпуска автомобиля;
6. Оцените влияние освещения на вероятность возникновения ДТП

2.2. Пропишем порядок решения для двух задач из списка. Обязательное условие — решение этих задач должно включать связь не менее 2-х таблиц. Пример прописанного порядка:
    - Создайте sql-запрос;
    - Постройте график;
    - Сделайте вывод.
    
Шаг 4. Создадим модель для оценки водительского риска
1. Подготовим набор данных на основе первичного предположения заказчика:
 
    - Выберем тип виновника — только машина (car). 
    - Возьмем случаи, когда ДТП привело к любым значимым повреждениям автомобиля любого из участников — все, кроме типа SCRATCH (царапина).
    - Для моделирования возьмем данные только за 2012 год.
    - Подготовка исходной таблицы должна проводиться с помощью sql-запроса.
2. Проведем первичный отбор факторов, необходимых для модели.
Изучим описание факторов. Нужно отобрать те, которые могут влиять на вероятность ДТП. Аргументируем свой выбор. 

Пример:

columms =['party_type',     # Тип участника происшествия. Таблица parties
          'party_sobriety', # Уровень трезвости виновника (точно может влиять) Таблица parties
           ......]
         
3. Проведем статистическое исследование отобранных факторов.
    - По результату исследовательского анализа внесем корректировки, если они нужны. Сделаем вывод.
    - Если необходимо, категоризируем исходные данные, проведем масштабирование.
    - Подготовим обучающую и тестовую выборки.
    
Шаг 5. Найдем лучшую модель

1. Смоделируем не менее 3-х типов моделей с перебором гиперпараметров.
2. 1–2 модели из спринта 2;
3. 1–2 модели из спринта 3.
4. Выберем метрику для оценки модели, исходя из поставленной бизнесом задачи, обосновав свой выбор.
5. Оформим вывод в виде сравнительной таблицы.

Шаг 6. Проверим лучшую модель в работе

1. Проведем графический анализ «Матрица ошибок». Выведем полноту и точность на график.
2. Проанализируем важность основных факторов, влияющих на вероятность ДТП.
3. Для одного из выявленных важных факторов проведем дополнительное исследование:
    - Покажем график зависимости фактора и целевой переменной.
    - Предложим, чем можно оборудовать автомобиль, чтобы учесть этот фактор во время посадки водителя.

Шаг 7. Сделаем общий вывод по модели
    - Кратко опишем лучшую модель.
    - Сделаем вывод: насколько возможно создание адекватной системы оценки риска при выдаче авто?
    - Какие факторы ещё необходимо собирать, чтобы улучшить модель?



## Итог исследования:

Мы обработали довольно объемную базу данных по ДТП, отобрали из нее необходиые данные, в частности, факторы, которые могут влиять на вероятность ДТП, преобразовали их из SQL в Pandas DataFrame, провели предобработку, построили 3 модели машинного обучения, выявили лучшую из них.

Кратко опишите лучшую модель: Catboost с подбором гиперпараметров через grid_search показывает метрику F1 в районе 0.79, то есть предсказывает порядка 79% ДТП. Гиперпараметры модели: {'iterations': 1000, 'learning_rate': 0.1, 'verbose': True, 'eval_metric': 'F1', 'depth': 6, 'l2_leaf_reg': 9}

После получения предсказаний от модели провели исследование feature importance, проанализировали графики и наши гипотезы по ним.

Сделайте вывод: насколько возможно создание адекватной системы оценки риска при выдаче авто?

Анализ feature importance показал, что иногда основное влияние на факт ДТП зависит не только от трезвости участника: почти в половине случаев в авариях виноваты не автомобили. Тем не менее, алкогольное опьянение водителя оказывает наибольшее влияние на вероятность ДТП. Поддерживаю идею заказчика оборудовать автомобиль анализатором алкогольного опьянения так, чтобы измерение состояния при посадке сделать обязательным условием допуска за руль.
Последний график также показывает, что важным фактором является исправное состояние автомобиля в каршеринговом сервисе.


## Стек технологий:

`pandas`, `matplotlib`, `numpy`, `seaborn`, `plotly.express`, `scikit-learn`, `sqlalchemy`, `catboost`, `ydata-profiling`
